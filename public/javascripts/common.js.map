{"version":3,"sources":["common.js"],"names":["$","doSearch","buildPlacemark","point","layout","ymaps","templateLayoutFactory","createClass","build","superclass","call","this","on","onRemove","onMoreInfoClick","onBtnCloseClick","onBtnEditClick","clear","off","alert","id","data","localStorage","getItem","parsedData","JSON","parse","closest","attr","forEach","el","i","mapObjects","splice","setItem","stringify","myCollection","remove","placemark","html","info","show","hide","_this","nameField","addressField","infoField","itemName","siblings","text","itemAddress","itemDescr","val","click","Placemark","lon","lat","iconContent","markName","name","address","descr","img","balloonContentLayout","preset","add","removeAll","length","map","geoObjects","setBounds","getBounds","getCoords","myGeocoder","geocode","then","res","geoObj","get","coords","geometry","getCoordinates","err","console","log","saveInLocal","getFromLocal","onFormSubmit","evt","preventDefault","obj","result","serializeArray","value","Date","now","push","target","reset","objectsForm","ready","Map","center","zoom","type","GeoObjectCollection"],"mappings":"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","file":"../sources/common.js","sourcesContent":["$(function() {\r\n\tconst objectsForm = $('.objects-form');\r\n\tlet map;\r\n\tlet myCollection;\r\n\tymaps.ready(function() {\r\n\t\tmap = new ymaps.Map('map', {\r\n\t\t\tcenter: [56.84, 60.60],\r\n\t\t\tzoom: 12,\r\n\t\t\ttype: 'yandex#map'\r\n\t\t});\r\n\r\n\t\tmyCollection = new ymaps.GeoObjectCollection();\r\n\t\tdoSearch();\r\n\t});\r\n\r\n\tlet mapObjects = [];\r\n\r\n\tgetFromLocal();\r\n\r\n\tfunction doSearch() {\r\n\t\tmyCollection.removeAll();\r\n\r\n\t\tfor (let i = 0; i < mapObjects.length; i++) {\r\n\t\t\tbuildPlacemark(mapObjects[i]);\r\n\t\t}\r\n\r\n\t\tfunction buildPlacemark(point) {\r\n\t\t\tconst layout = ymaps.templateLayoutFactory.createClass(\r\n\t\t\t\t`<div class=\"item\" data-id=\"{{properties.id}}\" data-descr=\"{{properties.descr}}\">\r\n\t\t\t\t<h3 class=\"item__name\">{{properties.name}}</h3>\r\n\t\t\t\t<h3 class=\"item__address\">{{properties.address}}</h3>\r\n\t\t\t\t<img src=\"{{properties.img}}\">\r\n\t\t\t\t<a href=\"#\" class=\"more-info\">Узнать подробнее</a>\r\n\t\t\t\t<button class=\"edit-placemark\">Изменить</button>\r\n\t\t\t\t<button class=\"remove-placemark\">Удалить</button>\r\n\t\t\t\t</div>`, \r\n\t\t\t\t{\r\n\t\t\t\t\tbuild: function() {\r\n\t\t\t\t\t\tlayout.superclass.build.call(this);\r\n\t\t\t\t\t\t$('.remove-placemark').on('click', this.onRemove);\r\n\t\t\t\t\t\t$('.more-info').on('click', this.onMoreInfoClick);\r\n\t\t\t\t\t\t$('.close-btn').on('click', this.onBtnCloseClick);\r\n\t\t\t\t\t\t$('.edit-placemark').on('click', this.onBtnEditClick);\r\n\t\t\t\t\t},\r\n\t\t\t\t\tclear: function() {\r\n\t\t\t\t\t\t$('.remove-placemark').off('click', this.onRemove);\r\n\t\t\t\t\t\t$('.more-info').off('click', this.onMoreInfoClick);\r\n\t\t\t\t\t\t$('.close-btn').off('click', this.onBtnCloseClick);\r\n\t\t\t\t\t\t$('.edit-placemark').off('click', this.onBtnEditClick);\r\n\t\t\t\t\t\tlayout.superclass.clear.call(this);\r\n\t\t\t\t\t},\r\n\t\t\t\t\tonRemove: function() {\r\n\t\t\t\t\t\talert('Удаление метки с id ' + point.id);\r\n\t\t\t\t\t\t// post на сервер\r\n\t\t\t\t\t\tconst data = localStorage.getItem('objects');\r\n\t\t\t\t\t\tconst parsedData = JSON.parse(data);\r\n\t\t\t\t\t\tconst id = $(this).closest('.item').attr('data-id');\r\n\t\t\t\t\t\tparsedData.forEach((el, i) => {\r\n\t\t\t\t\t\t\tif (id == el.id) {\r\n\t\t\t\t\t\t\t\tmapObjects.splice(i, 1);\r\n\t\t\t\t\t\t\t\tlocalStorage.setItem('objects', JSON.stringify(mapObjects));\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tmyCollection.remove(placemark);\r\n\t\t\t\t\t},\r\n\t\t\t\t\tonMoreInfoClick: function() {\r\n\t\t\t\t\t\t$('.info__text').html(point.info);\r\n\t\t\t\t\t\t$('.info').show();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tonBtnCloseClick: function() {\r\n\t\t\t\t\t\t$('.info').hide();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tonBtnEditClick: function() {\r\n\t\t\t\t\t\tconst nameField = $('.objects-form__name');\r\n\t\t\t\t\t\tconst addressField = $('.objects-form__address');\r\n\t\t\t\t\t\tconst infoField = $('.objects-form__info');\r\n\t\t\t\t\t\tconst itemName = $(this).siblings('.item__name').text();\r\n\t\t\t\t\t\tconst itemAddress = $(this).siblings('.item__address').text();\r\n\t\t\t\t\t\tconst itemDescr = $(this).closest('.item').attr('data-descr');\r\n\t\t\t\t\t\tnameField.val(itemName);\r\n\t\t\t\t\t\taddressField.val(itemAddress);\r\n\t\t\t\t\t\tinfoField.val(itemDescr);\r\n\t\t\t\t\t\t$('.overlay').show();\r\n\t\t\t\t\t\t$('.objects-form').on('submit', () => {\r\n\t\t\t\t\t\t\t$('.overlay').hide();\r\n\t\t\t\t\t\t\t$(this).siblings('.remove-placemark').click();\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\tconst placemark = new ymaps.Placemark([point.lon, point.lat], {\r\n\t\t\t\ticonContent: point.markName,\r\n\t\t\t\tname: point.name,\r\n\t\t\t\taddress: point.address,\r\n\t\t\t\tdescr: point.info,\r\n\t\t\t\timg: point.img,\r\n\t\t\t\tid: point.id\r\n\t\t\t}, {\r\n\t\t\t\tballoonContentLayout: layout,\r\n            preset: 'twirl#nightStretchyIcon' // иконка растягивается под контент\r\n          });\r\n\r\n\t\t\tmyCollection.add(placemark);\r\n\t\t}\r\n\r\n\t\tmap.geoObjects.add(myCollection);\r\n\r\n\t\tif (mapObjects.length > '2') {\r\n\t\t\tmap.setBounds(myCollection.getBounds());\r\n\t\t}\r\n\t};\r\n\r\n\tfunction getCoords (address) {\r\n\t\tconst myGeocoder = ymaps.geocode(address);\r\n\t\treturn myGeocoder.then(res => {\r\n\t\t\tconst geoObj = res.geoObjects.get(0);\r\n\t\t\tconst coords = geoObj ? geoObj.geometry.getCoordinates() : null;\r\n\t\t\treturn coords;\r\n\t\t})\r\n\t\t.catch(err => console.log(\"err: \", err))\r\n\t};\r\n\r\n\tfunction saveInLocal() {\r\n\t\tlocalStorage.setItem('objects', JSON.stringify(mapObjects));\r\n\t};\r\n\r\n\tfunction getFromLocal() {\r\n\t\tconst data = localStorage.getItem('objects');\r\n\t\tif (!data) {\r\n\t\t\treturn;\r\n\t\t} else {\r\n\t\t\tmapObjects = JSON.parse(data);\r\n\t\t}\r\n\t};\r\n\r\n\tfunction onFormSubmit(evt) {\r\n\t\tevt.preventDefault();\r\n\t\tconst obj = {};\r\n\t\tconst result = $(this).serializeArray();\r\n\t\tresult.forEach((el) => {\r\n\t\t\tobj[el.name] = el.value;\r\n\t\t});\r\n\r\n\t\tgetCoords(`'г. Екатеринбург, ${obj.address}`).then(data => {\r\n\t\t\tif(!data) {\r\n\t\t\t\talert('Неверный адрес');\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tobj.lon = data[0];\r\n\t\t\tobj.lat = data[1];\r\n\t\t\tobj.id = Date.now();\r\n\t\t\tmapObjects.push(obj);\r\n\t\t\tdoSearch();\r\n\t\t\tsaveInLocal();\r\n\t\t\tevt.target.reset();\r\n\t\t});\r\n\t};\r\n\r\n\tobjectsForm.on('submit', onFormSubmit);\r\n});"]}